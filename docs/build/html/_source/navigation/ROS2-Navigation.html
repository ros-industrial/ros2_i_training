

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>ROS2 Navigation &mdash; ROS2 workshop  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/override.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Under construction!" href="../manipulation/ROS2-TF2.html" />
    <link rel="prev" title="ROS2-Cartographer" href="ROS2-Cartographer.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ROS2 workshop
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../basics/ROS2-Filesystem.html">Exercise 1.0 - ROS2 filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/ROS2-Simple-Publisher-Subscriber.html">Exercise 1.1 - ROS2-Simple-Publisher-Subscriber</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/ROS2-Turtlebot.html">Exercise 1.2 - ROS2-Turtlebot</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ROS2-TF2.html">Exercise 2.1 - ROS2-TF2</a></li>
<li class="toctree-l1"><a class="reference internal" href="ROS2-Cartographer.html">Exercise 2.2 - ROS2-Cartographer</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Exercise 2.3 - ROS2-Navigation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#general-approach">2. General approach</a></li>
<li class="toctree-l2"><a class="reference internal" href="#temporary-load-the-map">3. Temporary load the Map</a></li>
<li class="toctree-l2"><a class="reference internal" href="#launch-the-navigation-stack">4. Launch the navigation stack</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#start-the-simulated-robot">4.1 Start the simulated robot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#start-the-real-robot">4.2 Start the real robot</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#navigate-the-robot-via-rviz">5. Navigate the robot via rviz</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../manipulation/ROS2-TF2.html">Exercise 3.1 - ROS2-Moveit2-Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manipulation/ROS2-Cartographer.html">Exercise 3.2 - ROS2-Moveit2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manipulation/ROS2-Navigation.html">Exercise 3.3 - ROS2-Application</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ROS2 workshop</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>ROS2 Navigation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/ipa320/ros-i_training/blob/_source/navigation/ROS2-Navigation.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ros2-navigation">
<h1>ROS2 Navigation<a class="headerlink" href="#ros2-navigation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The goal of this tutorial is</p>
<ul>
<li><p>to use the ROS2 navigation capabilities to move the robot autonomously.</p></li>
</ul>
</li>
<li><p>The packages you will use:</p>
<ul>
<li><p>workshop_ros2_navigation</p></li>
</ul>
</li>
</ul>
<p>Lines beginning with <code class="docutils literal notranslate"><span class="pre">#</span></code> indicates the syntax of these commands.</p>
<p>Commands are executed in a terminal:</p>
<ul class="simple">
<li><p>Open a new terminal → use the shortcut ctrl+alt+t.</p></li>
<li><p>Open a new tab inside an existing terminal → use the shortcut ctrl+shift+t.</p></li>
<li><p>Lines beginning with <code class="docutils literal notranslate"><span class="pre">$</span></code> indicates the syntax of these commands.</p></li>
<li><p>The computer of the real robot will be accessed from your local computer remotely. For every further command, a tag will inform which computer has to be used. It can be either <code class="docutils literal notranslate"><span class="pre">[TurtleBot]</span></code> or <code class="docutils literal notranslate"><span class="pre">[Remote</span> <span class="pre">PC]</span></code>.</p></li>
</ul>
<p>You can use the given links for further information.</p>
</div>
<div class="section" id="general-approach">
<h2>2. General approach<a class="headerlink" href="#general-approach" title="Permalink to this headline">¶</a></h2>
<p>The ROS 2 Navigation System is the control system that enables a robot to autonomously reach a goal state, such as a specific position and orientation relative to a specific map. Given a current pose, a map, and a goal, such as a destination pose, the navigation system generates a plan to reach the goal, and outputs commands to autonomously drive the robot, respecting any safety constraints and avoiding obstacles encountered along the way.</p>
<p>It consists of several ROS components. An overview of its interactions is depicted in the following picture:</p>
<p><img alt="navigation_overview" src="../../_images/navigation_overview.png" /></p>
<p>Figure 1: Navigation2 Architecture</p>
<p>source: <a class="reference external" href="https://navigation.ros.org/_images/architectural_diagram.png">navigataion</a></p>
</div>
<div class="section" id="temporary-load-the-map">
<h2>3. Temporary load the Map<a class="headerlink" href="#temporary-load-the-map" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Use the map generated during the cartographer tutorial.</p></li>
</ul>
<p><strong>A. Once your map is saved, check:</strong></p>
<p><strong>1.</strong> all processes on your robot are shutdown.</p>
<p>You can check it using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ros2 node list
</pre></div>
</div>
<p>The output should be empty, otherwise, there are still running processes.</p>
<p><strong>2.</strong> The location of the <strong>map.yaml</strong> and <strong>map.pgm</strong>.</p>
<p>For example, the workspace has the following layout:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nav_ws/
  maps/
    map.yaml
    map.pgm
    map_server_params.yaml
  src/
  build/
  install/
  log/
</pre></div>
</div>
<p><strong>B. Create a parameter file for map_server</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">[Remote</span> <span class="pre">PC]</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> your_workspace
$ touch map_server_params.yaml
$ nano map_server_params.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># map_server_params.yaml</span>
<span class="nt">map_server</span><span class="p">:</span>
    <span class="nt">ros__parameters</span><span class="p">:</span>
        <span class="nt">frame_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">map</span>
        <span class="nt">topic_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">map</span>
        <span class="nt">use_sim_time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
        <span class="nt">yaml_filename</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">maps/map.yaml</span>
</pre></div>
</div>
<p><strong>Hint</strong>:</p>
<ul class="simple">
<li><p>make sure there is right path of <em>map.pgm</em> in <em>map.yaml</em>. The path of map.png in map.yaml is relative. So if “map.yaml” and “map.png” are in the same folder, the parameter of “image:” should be “image: map.pgm”</p></li>
<li><p>in “map_server_params.yaml”, the path of “yaml_filename” is also relative.  So if “map_server_params.yaml” and “map.yaml” are in the same folder, the parameter of “image:” should be “yaml_filename: map.yaml”.</p></li>
</ul>
<p><strong>C. Start map_server</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">[Remote</span> <span class="pre">PC]</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>```bash
$ ros2 run nav2_map_server map_server --ros-args \ --params-file maps/map_server_params.yaml&quot;
```
</pre></div>
</div>
<p><strong>map_server</strong> is  a lifecycle node and needs to be transitioned to the active state.</p>
<p>In other terminal:
Run this command to check that state transition.</p>
<p><code class="docutils literal notranslate"><span class="pre">[Remote</span> <span class="pre">PC]</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ros2 lifecycle list /map_server
</pre></div>
</div>
<p>Run this command to trigger <strong>map_server</strong>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ros2 lifecycle <span class="nb">set</span> /map_server <span class="m">1</span>
</pre></div>
</div>
<p><strong>D. Start <strong>rviz2</strong> to view the map</strong>
Start a new terminal, source ros foxy workspace:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ rviz2
</pre></div>
</div>
<p>In rviz2, choose “add”, “by topic” and “/map”</p>
<p>In other terminal, active <strong>map_server</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ros2 lifecycle <span class="nb">set</span> /map_server <span class="m">3</span>
</pre></div>
</div>
<p>Then you can see the map in rviz2</p>
<!-- pagebreak  --></div>
<div class="section" id="launch-the-navigation-stack">
<h2>4. Launch the navigation stack<a class="headerlink" href="#launch-the-navigation-stack" title="Permalink to this headline">¶</a></h2>
<p>Start either the simulated robot or the real robot!</p>
<p>Before starting, you need check that you already terminate the process of rviz2 and map_server.</p>
<div class="section" id="start-the-simulated-robot">
<h3>4.1 Start the simulated robot<a class="headerlink" href="#start-the-simulated-robot" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>a. Open a terminal</p></li>
<li><p>b. Set key environment variables</p>
<p>First you need to go into your workspace and source your workspace:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">source</span> install/setup.bash
</pre></div>
</div>
<p>Set up Gazebo model path:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">GAZEBO_MODEL_PATH</span><span class="o">=</span><span class="sb">`</span>ros2 pkg <span class="se">\</span>
prefix turtlebot3_gazebo<span class="sb">`</span>/share/turtlebot3_gazebo/models/
</pre></div>
</div>
<p>set up the robot model that you will use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">TURTLEBOT3_MODEL</span><span class="o">=</span>burger
</pre></div>
</div>
<p>Here we use “11” as ROS Domain ID:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">ROS_DOMAIN_ID</span><span class="o">=</span><span class="m">11</span>
</pre></div>
</div>
</li>
<li><p>c. Bring up Turtlebot in simulation
in the same terminal, run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ros2 launch turtlebot3_gazebo turtlebot3_world.launch.py
</pre></div>
</div>
<p>d. Start navigation stack
open another terminal, source your workspace, set up the robot model that you will use, then</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ros2 launch turtlebot3_navigation2 <span class="se">\</span>
navigation2.launch.py <span class="se">\</span>
use_sim_time:<span class="o">=</span><span class="nb">true</span> map:<span class="o">=</span>maps/map.yaml
</pre></div>
</div>
<p>The path of the map is relative to the place where you will run this command.</p>
<p>You also can use this command to check which parameter that you can define:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 launch turtlebot3_navigation2 navigation2.launch.py <span class="se">\</span>
--show-args
</pre></div>
</div>
<p>If everything has started correctly, you will see the RViz and Gazebo GUIs like this.
<img alt="rviz_navigation_1" src="../../_images/rviz_navigation_1.png" /></p>
<p><img alt="gazebo_navigation_1" src="../../_images/gazebo_navigation_1.png" /></p>
</li>
</ul>
</div>
<div class="section" id="start-the-real-robot">
<h3>4.2 Start the real robot<a class="headerlink" href="#start-the-real-robot" title="Permalink to this headline">¶</a></h3>
<p><em><strong>First try on simulation and finish next chapter then try it on real robot.</strong></em></p>
<!-- Before start use navigation, make sure you have `workshop_ros2_navigation` in your source folder in `/src` in your workspace. 
 --><p>Open a terminal on TurtleBot3.</p>
<p>Bring up basic packages to start TurtleBot3 applications.</p>
<p><code class="docutils literal notranslate"><span class="pre">[TurtleBot3]</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">source</span> .bashrc
$ ros2 launch turtlebot3_bringup robot.launch.py
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">[Remote</span> <span class="pre">PC]</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="s2">&quot;your workspace&quot;</span>
$ <span class="nb">source</span> install/setup.bash
$ <span class="nb">export</span> <span class="nv">ROS_DOMAIN_ID</span> <span class="o">=</span>
 <span class="s2">&quot;same as ROS DOMAIN ID of the turtlebot you are using&quot;</span>
$ ros2 launch turtlebot3_navigation2 navigation2.launch.py<span class="se">\</span>
 map:<span class="o">=</span>maps/map.yaml
</pre></div>
</div>
</div>
</div>
<div class="section" id="navigate-the-robot-via-rviz">
<h2>5. Navigate the robot via rviz<a class="headerlink" href="#navigate-the-robot-via-rviz" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p><strong>Step 1: Tell the robot where it is</strong></p>
<p>after starting, the robot initially has no idea where it is. By default, Navigation 2 waits for you to give it an approximate starting position.</p>
<p>It has to manually update the initial location and orientation of the TurtleBot3. This information is applied to the AMCL algorithm.</p>
<p>This can be done graphically with RViz by the instruction below:
<img alt="rviz_initial" src="../../_images/rviz_initial.png" /></p>
<ul class="simple">
<li><p>Click “2D Pose Estimate” button (in the top menu; see the picture)</p></li>
<li><p>Click on the approximate point in the map where the TurtleBot3 is located and drag the cursor to indicate the direction where TurtleBot3 faces.</p></li>
</ul>
<p>If you don’t get the location exactly right, that’s fine. Navigation 2 will refine the position as it navigates. You can also, click the “2D Pose Estimate” button and try again, if you prefer.</p>
<p>Once you’ve set the initial pose, the tf tree will be complete and Navigation 2 is fully active and ready to go.</p>
<p>If you are using simulation with turtlrbot_world map, it will show as below:
<img alt="Navigation_is_ready_sim" src="../../_images/Navigation_is_ready_sim.png" /></p>
<p>As soon as the 2D Pose Estimation arrow is drawn, the pose (transformation from the map to the robot) will update. As a result the centre of the laser scan has changed, too. Check if the visualization of the live laser scan matches the contours
of the virtual map (Illustrated in the following two pictures! The left one is the wrong robot pose and the right one is right robot pose) to confirm that the new starting pose is accurate.</p>
<p><img alt="bad" src="../../_images/bad.png" /></p>
<p><img alt="good" src="../../_images/good.png" /></p>
</li>
<li><p><strong>Step 2: Give a goal</strong></p>
<p>if the TurtleBot3 is localized, it can automatically create a path from the current position to any target reachable position on the map. In order to set a goal position, follow the instruction below:</p>
<ul class="simple">
<li><p>Click the 2D Nav Goal button (also in the top menu)</p></li>
<li><p>Click on a specific point in the map to set a goal position and drag the cursor to the direction where TurtleBot should be facing at the end</p></li>
</ul>
<p><em><strong>Hint: If you wish to stop the robot before it reaches to the goal position, set the current position of TurtleBot3 as a goal position.</strong></em></p>
<p>The swarm of the green small arrows is the visualization of the <strong>adaptive Monte Carlo localization (AMCL)</strong>. Every green arrow stands for a possible position and orientation of the TurtleBot3. Notice that in the beginning its distribution is spread over the whole map. As soon as the robot moves the arrows get updated because the algorithm incorporates new measurements. During the movement the distribution of arrows becomes less chaotic and settles more and more to the robot’s location, which finally means that the algorithm becomes more and more certain about the pose of the robot in the map.</p>
</li>
<li><p><strong>Step 3: Play around</strong><br />When the robot is on the way to the goal, you can put an obstacle in Gazebo:
<img alt="nav_goal_ob_1" src="../../_images/nav_goal_ob_1.png" /></p>
<p>You can see how the robot reacts to this kind of situation:
<img alt="nav_goal_ob_2" src="../../_images/nav_goal_ob_2.png" /></p>
<p>It depends on how you design the behavior tree structure. The one we are using is “navigate_w_replanning_and_recovery.xml” You can find in this <a class="reference external" href="https://github.com/ros-planning/navigation2/blob/foxy-devel/nav2_bt_navigator/behavior_trees/navigate_w_replanning_and_recovery.xml">link</a></p>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../manipulation/ROS2-TF2.html" class="btn btn-neutral float-right" title="Under construction!" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="ROS2-Cartographer.html" class="btn btn-neutral float-left" title="ROS2-Cartographer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Fraunhofer IPA.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>

  
  
    
   

</body>
</html>