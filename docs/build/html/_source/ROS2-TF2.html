

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>TF2 - The second generation of the transform library &mdash; ROS2 workshop  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> ROS2 workshop
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">TF2 - The second generation of the transform library</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#dynamic-tf-broadcaster">1. Dynamic TF Broadcaster</a><ul>
<li><a class="reference internal" href="#explanation">1.1 Explanation</a></li>
<li><a class="reference internal" href="#declaring-the-executable">1.2 Declaring the executable</a></li>
<li><a class="reference internal" href="#testing-the-broadcaster">1.3 Testing the Broadcaster</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tf-listener">2. TF Listener</a><ul>
<li><a class="reference internal" href="#id1">2.1 Explanation</a></li>
<li><a class="reference internal" href="#testing-the-listener">2.2 Testing the listener</a></li>
</ul>
</li>
<li><a class="reference internal" href="#static-transform-broadcaster">3. Static Transform Broadcaster</a><ul>
<li><a class="reference internal" href="#testing-the-static-broadcaster">3.1 Testing the static broadcaster</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ROS2 workshop</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>TF2 - The second generation of the transform library</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/_source/ROS2-TF2.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tf2-the-second-generation-of-the-transform-library">
<h1>TF2 - The second generation of the transform library<a class="headerlink" href="#tf2-the-second-generation-of-the-transform-library" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This tutorial will help you understand the flexibility of transforms with the TF2 library. It will introduce Dynamic Transform Broadcasters, Transform Listeners and Static Transform Broadcasters.</p>
<p>For this tutorial, we will use the Turtlesim again. This time, we will insert a second turtle into the simulation. As you drive the first turtle around with keyboard teleop, the second turte will follow it closely. In order to do this, the second turtle needs to know where the first one is, w.r.t. its own coordinate frames. This can be easily achieved using the TF2 library.</p>
<p>The example code is based on <a class="reference external" href="https://github.com/ros2/geometry2/tree/eloquent/examples_tf2_py">tf2_example</a> and is tested with ROS2 Foxy.</p>
</div>
<div class="section" id="dynamic-tf-broadcaster">
<h2>1. Dynamic TF Broadcaster<a class="headerlink" href="#dynamic-tf-broadcaster" title="Permalink to this headline">¶</a></h2>
<p>The word dynamic indicates that the transform that is being published is constantly changing. This is useful for tracking moving parts. In this case, we continuously broadcast the current position of the first turtle.</p>
<p>Create an ament python package with dependencies on tf2_ros (Use the “depend” tag).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 pkg create --build-type ament_python &lt;package_name&gt; --dependencies tf2_ros rclpy
</pre></div>
</div>
<p>Create a new python script in this package (under the folder with the package name) and register it as an executable in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>. For the purpose of this document, the package name is assumed as <code class="docutils literal notranslate"><span class="pre">tf2_workshop</span></code> and executable name as <code class="docutils literal notranslate"><span class="pre">broadcaster</span></code>.</p>
<p>Make sure the scipy library is installed:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip3 install scipy
</pre></div>
</div>
<p>Copy the code shown below into the new file, save it, and build it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">TransformStamped</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span> <span class="k">as</span> <span class="n">R</span>
<span class="kn">from</span> <span class="nn">tf2_ros.transform_broadcaster</span> <span class="kn">import</span> <span class="n">TransformBroadcaster</span>
<span class="kn">from</span> <span class="nn">turtlesim.msg</span> <span class="kn">import</span> <span class="n">Pose</span>

<span class="k">class</span> <span class="nc">DynamicBroadcaster</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">turtle_name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;dynamic_broadcaster&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_</span> <span class="o">=</span> <span class="n">turtle_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Broadcasting pose of : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tfb_</span> <span class="o">=</span> <span class="n">TransformBroadcaster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span><span class="n">Pose</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/pose&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_pose</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        
        <span class="n">tfs</span> <span class="o">=</span> <span class="n">TransformStamped</span><span class="p">()</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_msg</span><span class="p">()</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span><span class="o">=</span><span class="s2">&quot;world&quot;</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">_child_frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">x</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">y</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>  

        <span class="n">r</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">msg</span><span class="o">.</span><span class="n">theta</span><span class="p">])</span>

        <span class="n">tfs</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">as_quat</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">as_quat</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">as_quat</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tfs</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">as_quat</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tfb_</span><span class="o">.</span><span class="n">sendTransform</span><span class="p">(</span><span class="n">tfs</span><span class="p">)</span>    

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">DynamicBroadcaster</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Next, add this script to the</p>
<div class="section" id="explanation">
<h3>1.1 Explanation<a class="headerlink" href="#explanation" title="Permalink to this headline">¶</a></h3>
<p>This follows the same basic structure for a ROS2 node. The TF2 specific lines will be explained.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">TransformStamped</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span> <span class="k">as</span> <span class="n">R</span>
<span class="kn">from</span> <span class="nn">tf2_ros.transform_broadcaster</span> <span class="kn">import</span> <span class="n">TransformBroadcaster</span>
</pre></div>
</div>
<p>Imports the modules required for TF2. Scipy is used to convert from Euler angles to quaternion since the <code class="docutils literal notranslate"><span class="pre">tf_conversions</span></code> package has not been ported over to ROS2 yet.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">tfb_</span> <span class="o">=</span> <span class="n">TransformBroadcaster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>Initializes a dynamic transform broadcaster which sends the transforms.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">name_</span> <span class="o">=</span> <span class="n">turtle_name</span>
</pre></div>
</div>
<p>The name of the turtle for which we are broadcasting comes from the CLI as an argument.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tfs</span> <span class="o">=</span> <span class="n">TransformStamped</span><span class="p">()</span>
<span class="o">...</span>
<span class="bp">self</span><span class="o">.</span><span class="n">tfb_</span><span class="o">.</span><span class="n">sendTransform</span><span class="p">(</span><span class="n">tfs</span><span class="p">)</span> 
</pre></div>
</div>
<p>Create a transform datatype with a header and populate it with meaningful data.
The parent frame is always “world” and the child frame (i.e. current frame being published) is the name chosen. Transmit this transformation from within the subscriber callback. This implies it updates the frame (nearly) as fast as it receives the pose.</p>
<ul class="simple">
<li><p>Header</p>
<ul>
<li><p>Timestamp :
(Determine the moment when this transform is happening. This is mainly
rclpy.Time.time() when you want to send the actual transform. This means the
transform can change over time to generate a dynamic motion.)</p></li>
<li><p>Frame_ID : (The frame ID of the origin frame)</p></li>
</ul>
</li>
<li><p>Child Frame ID:
(Frame ID to which the transform is happening)</p></li>
<li><p>Transform</p>
<ul>
<li><p>Position : in meter (X, Y and Z)</p></li>
<li><p>Orientation : in Quaternion (You can use the TF Quaternion from Euler function to use the roll, pitch and yaw angles in rad instead)</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="declaring-the-executable">
<h3>1.2 Declaring the executable<a class="headerlink" href="#declaring-the-executable" title="Permalink to this headline">¶</a></h3>
<p>Now that we have our code written and dependencies setup, we need to tell our build system that the script we created should be treated as an executable. We do this in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>. Look for the section that starts with <code class="docutils literal notranslate"><span class="pre">entry_points={</span></code>. We edit this part to declare the executable and its entry point to look like this:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;console_scripts&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;broadcaster = tf2_workshop.broadcaster:main&#39;</span><span class="p">,</span>
        <span class="p">],</span>
<span class="p">},</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-the-broadcaster">
<h3>1.3 Testing the Broadcaster<a class="headerlink" href="#testing-the-broadcaster" title="Permalink to this headline">¶</a></h3>
<p>First, start the turtlesim node :<br /><code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">run</span> <span class="pre">turtlesim</span> <span class="pre">turtlesim_node</span></code></p>
<p>Then start the broadcaster, with your chosen name for the turtle as the only argument. Here we assume <code class="docutils literal notranslate"><span class="pre">turtle1</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">run</span> <span class="pre">tf2_workshop</span> <span class="pre">broadcaster</span> <span class="pre">turtle1</span></code></p>
<p>If all works well, the broadcaster is now sending the TF data for turtle1. This can be verified with:<br /><code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">run</span> <span class="pre">tf2_ros</span> <span class="pre">tf2_echo</span> <span class="pre">turtle1</span> <span class="pre">world</span></code><br />or by simply running:<br /><code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">run</span> <span class="pre">tf2_ros</span> <span class="pre">tf2_monitor</span></code><br />or also through rviz2 by adding the <code class="docutils literal notranslate"><span class="pre">TF</span></code> display module.</p>
</div>
</div>
<div class="section" id="tf-listener">
<h2>2. TF Listener<a class="headerlink" href="#tf-listener" title="Permalink to this headline">¶</a></h2>
<p>Once your robot system has a fully fleshed out TF tree with valid data at a good frequency, you can then make use of these transforms for your application through listeners, which actually solve inverse kinematics for you. This is the true power of TF2.</p>
<p>In the following example, we will create a TF listener, which listens to the TF tree to get the transformation between the first and the second turtle.</p>
<p>Create another new python file for the listener and add it as an executable. This document assumes the name <code class="docutils literal notranslate"><span class="pre">listener</span></code> for it.</p>
<p>Copy the following code into the file and save it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span>

<span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">rclpy.qos</span> <span class="kn">import</span> <span class="n">QoSProfile</span>
<span class="kn">from</span> <span class="nn">tf2_ros.transform_listener</span> <span class="kn">import</span> <span class="n">TransformListener</span>
<span class="kn">from</span> <span class="nn">tf2_ros.buffer</span> <span class="kn">import</span> <span class="n">Buffer</span>
<span class="kn">from</span> <span class="nn">tf2_ros</span> <span class="kn">import</span> <span class="n">LookupException</span>

<span class="k">class</span> <span class="nc">TfListener</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_turtle</span><span class="p">,</span> <span class="n">second_turtle</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;tf_listener&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_name_</span> <span class="o">=</span> <span class="n">first_turtle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">second_name_</span> <span class="o">=</span> <span class="n">second_turtle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transforming from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second_name_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name_</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tf_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tf_listener</span> <span class="o">=</span> <span class="n">TransformListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tf_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_</span> <span class="o">=</span> <span class="n">Twist</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">Twist</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/cmd_vel&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second_name_</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer_callback</span><span class="p">)</span> <span class="c1">#30 Hz = 0.333s</span>

    <span class="k">def</span> <span class="nf">timer_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second_name_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name_</span><span class="p">,</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">y</span> <span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">LookupException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to get transform </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">TfListener</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="id1">
<h3>2.1 Explanation<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The new lines are explained here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tf2_ros.transform_listener</span> <span class="kn">import</span> <span class="n">TransformListener</span>   
<span class="kn">from</span> <span class="nn">tf2_ros.buffer</span> <span class="kn">import</span> <span class="n">Buffer</span>
<span class="kn">from</span> <span class="nn">tf2_ros</span> <span class="kn">import</span> <span class="n">LookupException</span>
</pre></div>
</div>
<p>These modules are required for listeners. Recall that the buffer provides an abstracted API of the core TF2 package which is ROS agnostic.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">_tf_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_tf_listener</span> <span class="o">=</span> <span class="n">TransformListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tf_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>Boilerplate code for setting up a new listener.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second_name_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name_</span><span class="p">,</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">())</span>
</pre></div>
</div>
<p>The main workhorse of this node. The syntax accepts the target frame first and the source frame second. In other words, the pose of the origin of the source frame w.r.t the target frame. It calculates the transformation from the first turtle to the second turtle, which tells us how far away turtle1 is from turtle2.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmd_</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">y</span> <span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_</span><span class="p">)</span>
</pre></div>
</div>
<p>This part is a very simply controller, that generates velocity commands based on the distance remaining. This part can be replaced by any other controller you wish to try for the following motion.</p>
<p>Make sure to add the listener as an executable as well (refer to the previous section) and then rebuild the package.</p>
</div>
<div class="section" id="testing-the-listener">
<h3>2.2 Testing the listener<a class="headerlink" href="#testing-the-listener" title="Permalink to this headline">¶</a></h3>
<p>The turtlesim simulation and teleop node need to be running first.</p>
<p>To test the application, you first need to spawn a second turtle, the name of which is assumed here to be <code class="docutils literal notranslate"><span class="pre">turtle2</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 service call /spawn turtlesim/srv/Spawn <span class="s2">&quot;{x: 2, y: 2, theta: 0.2, name: &quot;</span>turtle2<span class="s2">&quot;}&quot;</span>
</pre></div>
</div>
<p>The parameters indicate the starting pose and name.</p>
<p>You also need to start up another TF broadcaster for this new turtle, similar to the previous one, but with the name of this turtle instead.</p>
<p>Finally, run the executable node for the listener by passing the first argument as the name of the first turtle and the second argument as the name of the second turtle:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 run tf2_workshop listener turtle1 turtle2
</pre></div>
</div>
<p>Now when you move around the first turtle using the keyboard, the second turtle follows it.</p>
<p>You can once again check the TF tree to observe the new additions.</p>
</div>
</div>
<div class="section" id="static-transform-broadcaster">
<h2>3. Static Transform Broadcaster<a class="headerlink" href="#static-transform-broadcaster" title="Permalink to this headline">¶</a></h2>
<p>The dynamic transform broadcaster is used for moving objects. But for parts that do not move, the simpler static broadcaster does the job well. This could be used for instances like a camera fixed in a room, or a lidar mounted on a mobile robot.</p>
<p>The static publisher is already available as an executable node, and it can simply be started with the right command line arguments which are in order :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Translation.x, Translation.y, Translation.z, Rotation.yaw, Rotation.pitch, Rotation.roll, Parent frame, child frame
</pre></div>
</div>
<p>For example :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 run tf2_ros static_transform_publisher <span class="m">0</span>.1 <span class="m">0</span> <span class="m">0</span> -1.57 <span class="m">0</span>.0 <span class="m">0</span>.0 turtle1 turtle_cam1
</pre></div>
</div>
<p>This will add the frame <code class="docutils literal notranslate"><span class="pre">turtle_cam1</span></code> related to the <code class="docutils literal notranslate"><span class="pre">turtle1</span></code> frame.
The virtual camera is mounted +0.1 m in x-axis from view of the turtle base and rotated -1.57 rad in yaw. This might not make much real world sense, but hey it’s just an example!</p>
<div class="section" id="testing-the-static-broadcaster">
<h3>3.1 Testing the static broadcaster<a class="headerlink" href="#testing-the-static-broadcaster" title="Permalink to this headline">¶</a></h3>
<p>The TF published is exactly of the same format as the dynamic publisher, and this can be easily verified with any of the aforementioned means.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Fraunhofer IPA.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>