

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Understanding ROS2 nodes with a simple Publisher - Subscriber pair &mdash; ROS2 workshop  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> ROS2 workshop
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Understanding ROS2 nodes with a simple Publisher - Subscriber pair</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#publisher-node">1. Publisher Node</a><ul>
<li><a class="reference internal" href="#explanation">1.1 Explanation</a></li>
<li><a class="reference internal" href="#add-dependencies">1.2 Add dependencies</a></li>
<li><a class="reference internal" href="#declaring-the-executable">1.3 Declaring the executable</a></li>
<li><a class="reference internal" href="#setup-cfg">1.4 Setup.cfg</a></li>
</ul>
</li>
<li><a class="reference internal" href="#subscriber-node">2 Subscriber Node</a><ul>
<li><a class="reference internal" href="#id1">2.1 Explanation</a></li>
<li><a class="reference internal" href="#id2">2.2 Declaring the executable</a></li>
</ul>
</li>
<li><a class="reference internal" href="#build-and-run">3 Build and run</a></li>
<li><a class="reference internal" href="#composed-nodes">4 Composed nodes</a><ul>
<li><a class="reference internal" href="#id3">4.1 Explanation</a></li>
<li><a class="reference internal" href="#id4">4.2 Declaring the executable</a></li>
<li><a class="reference internal" href="#id5">4.3 Build and run</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ROS2 workshop</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Understanding ROS2 nodes with a simple Publisher - Subscriber pair</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/_source/ROS2-Simple-Publisher-Subscriber.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="understanding-ros2-nodes-with-a-simple-publisher-subscriber-pair">
<h1>Understanding ROS2 nodes with a simple Publisher - Subscriber pair<a class="headerlink" href="#understanding-ros2-nodes-with-a-simple-publisher-subscriber-pair" title="Permalink to this headline">¶</a></h1>
<p><strong>Based on the <a class="reference external" href="https://index.ros.org/doc/ros2/Tutorials/Writing-A-Simple-Py-Publisher-And-Subscriber/">ROS2 Tutorials</a></strong></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>As we understood from the lectures, nodes are the fundamental units in ROS2 which are usually written to perform a specific task. They can be created in a few different ways such as-</p>
<ol class="simple">
<li><p>As simple in-line code in a script,</p></li>
<li><p>As local functions, and</p></li>
<li><p>As class objects<br />… among others</p></li>
</ol>
<p>We will be using the 3rd method, though it is the more complex, so as to get better used to this concept.</p>
<p>We start by writing two separate simple nodes, one that includes only publisher and another that includes only a subscriber. Finally, we will write a third node that includes both within the same program and are managed through an executor.</p>
<p>The first step is to create a python package package to house all our nodes. You can do so using the command</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ros2 pkg create --build-type ament_python &lt;package_name&gt;
</pre></div>
</div>
<p>(Make sure first that ROS2 is sourced in every new terminal)</p>
<p>Make sure you run this command in the <em>src</em> directory of your workspace. You can use any package name you want, but for reference in this document, we call it <code class="docutils literal notranslate"><span class="pre">wshop_nodes</span></code>.</p>
</div>
<div class="section" id="publisher-node">
<h2>1. Publisher Node<a class="headerlink" href="#publisher-node" title="Permalink to this headline">¶</a></h2>
<p>The publisher and subscriber nodes used here are in fact the <a class="reference external" href="https://github.com/ros2/examples/blob/master/rclpy/topics/minimal_publisher/examples_rclpy_minimal_publisher/publisher_member_function.py">example code</a> that ROS2 provides.</p>
<p>We first present the code completely, and then discuss the interesting parts:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>


<span class="k">class</span> <span class="nc">MinimalPublisher</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;minimal_publisher&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s1">&#39;topic&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">timer_period</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="n">timer_period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">timer_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;Hello World: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Publishing: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

    <span class="n">minimal_publisher</span> <span class="o">=</span> <span class="n">MinimalPublisher</span><span class="p">()</span>

    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">minimal_publisher</span><span class="p">)</span>

    <span class="c1"># Destroy the node explicitly</span>
    <span class="c1"># (optional - otherwise it will be done automatically</span>
    <span class="c1"># when the garbage collector destroys the node object)</span>
    <span class="n">minimal_publisher</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Inside the python package you created above, there should be another folder with the same name. Create a python file inside that folder and paste this code in. You can name the file anything you want, but for reference in this document we assign the name <code class="docutils literal notranslate"><span class="pre">minimal_publisher.py</span></code> to it.</p>
<div class="section" id="explanation">
<h3>1.1 Explanation<a class="headerlink" href="#explanation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">rclpy</span></code> is the <em>ROS2 Client Library</em> that provides the API for invoking ROS2 through Python.<br /><code class="docutils literal notranslate"><span class="pre">Node</span></code> is the main class which will be inherited here to instantiate our own node.<br /><code class="docutils literal notranslate"><span class="pre">std_msgs.msg</span></code> is the library for standard messages that includes the <code class="docutils literal notranslate"><span class="pre">String</span></code> message type which we use in this node. This has to be declared as a dependency in <code class="docutils literal notranslate"><span class="pre">package.xml</span></code>, which we do next.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MinimalPublisher</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;minimal_publisher&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s1">&#39;topic&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">timer_period</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="n">timer_period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>As explained above, we create a subclass of type <code class="docutils literal notranslate"><span class="pre">MinimalPublisher</span></code> using the base class <code class="docutils literal notranslate"><span class="pre">Node</span></code>.<br />In the constructor <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>, we pass the name of the node that we ish to assign to the constructer of the parent class using <code class="docutils literal notranslate"><span class="pre">super()</span></code>. The parent class <code class="docutils literal notranslate"><span class="pre">Node</span></code> takes care of actually assigning this string as a name.<br /><code class="docutils literal notranslate"><span class="pre">self.publisher_</span> <span class="pre">=</span> <span class="pre">self.create_publisher(String,</span> <span class="pre">'topic',</span> <span class="pre">10)</span></code> This line actually creates a publisher, using the message type <code class="docutils literal notranslate"><span class="pre">String</span></code> that we imported, with the name <code class="docutils literal notranslate"><span class="pre">topic</span></code> that we choose and having a queue size of <code class="docutils literal notranslate"><span class="pre">10</span></code>. Queue size is the size of the output buffer. The commands used till now are typical when creating a subscriber. What follows next is only logic that is relevant to this node, and you may implement this in any way depending on your requirements.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">timer_period</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># seconds</span>
<span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="n">timer_period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer_callback</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>This creates a timer that ticks every 0.5s (2Hz), and calls the function <code class="docutils literal notranslate"><span class="pre">timer_callback</span></code> at every tick.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">timer_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;Hello World: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Publishing: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>In the callback, we create an object <code class="docutils literal notranslate"><span class="pre">msg</span></code> of the type of the message we wish to publish, i.e <code class="docutils literal notranslate"><span class="pre">String</span></code>.<br />We then populate the message with information we wish to publish. Looking at the description of the msg type using <code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">interface</span> <span class="pre">show</span> <span class="pre">std_msgs/msg/String</span></code>, we see that it has only one field, which is <code class="docutils literal notranslate"><span class="pre">string</span> <span class="pre">data</span></code>. So we add a string into this field. Depending on the type of message used, you can populate it with relevant data.<br />Once the data msg object is done, we simply publish it using the <code class="docutils literal notranslate"><span class="pre">publish()</span></code> method of the <code class="docutils literal notranslate"><span class="pre">publisher_</span></code> object.<br />We also display this same message on the console for our verification using the <code class="docutils literal notranslate"><span class="pre">get_logger().info()</span></code> method of our <code class="docutils literal notranslate"><span class="pre">Node</span></code> class object.<br />Publishing from within this timer callback ensures we have a consistent publishing rate of 2Hz. You could publish this in any way you want, using the proper message type and publish call.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

    <span class="n">minimal_publisher</span> <span class="o">=</span> <span class="n">MinimalPublisher</span><span class="p">()</span>

    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">minimal_publisher</span><span class="p">)</span>

    <span class="c1"># Destroy the node explicitly</span>
    <span class="c1"># (optional - otherwise it will be done automatically</span>
    <span class="c1"># when the garbage collector destroys the node object)</span>
    <span class="n">minimal_publisher</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
<p>In the main method, we first declare that this Python script uses the rclpy library by invoking <code class="docutils literal notranslate"><span class="pre">init()</span></code> and passing any command line arguments provided (in this case none).<br />We instantiate an object of the class we just created. Since the contructor already spawns the timer which publishes messages, no further action is needed to setup our node.<br />The <code class="docutils literal notranslate"><span class="pre">spin()</span></code> method ensures that all the items of work, such as callbacks, are continuously executed until a <code class="docutils literal notranslate"><span class="pre">shutdown()</span></code> is called. This is quintessential to ensure that your node actually does its job!<br />Finally, we destroy the node and manually call shutdown.</p>
</div>
<div class="section" id="add-dependencies">
<h3>1.2 Add dependencies<a class="headerlink" href="#add-dependencies" title="Permalink to this headline">¶</a></h3>
<p>In the base root folder of this package, you will find the <code class="docutils literal notranslate"><span class="pre">package.xml</span></code> which is important for declaring all dependancies of the package. We will now edit this file to ensure our code runs properly.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">description</span></code>, <code class="docutils literal notranslate"><span class="pre">maintainer</span></code> and <code class="docutils literal notranslate"><span class="pre">license</span></code> tage should be appropriately filled out. For license, use any valid open source license like <code class="docutils literal notranslate"><span class="pre">Apache</span> <span class="pre">License</span> <span class="pre">2.0</span></code>.</p>
<p>The buildtool we use by default is <code class="docutils literal notranslate"><span class="pre">ament_python</span></code> and you can see that this has already been assigned when we used the <code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">pkg</span> <span class="pre">create</span></code> command. Below this, add the following two lines :</p>
<div class="highlight-XML notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;exec_depend&gt;</span>rclpy<span class="nt">&lt;/exec_depend&gt;</span>
<span class="nt">&lt;exec_depend&gt;</span>std_msgs<span class="nt">&lt;/exec_depend&gt;</span>
</pre></div>
</div>
<p>We already know from section <strong>1.1</strong> what these dependancies are. We jsut need to declare that these two libraries need to be included during execution time. (Buildtime dependencies are not required for Python)</p>
</div>
<div class="section" id="declaring-the-executable">
<h3>1.3 Declaring the executable<a class="headerlink" href="#declaring-the-executable" title="Permalink to this headline">¶</a></h3>
<p>Now that we have our code written and dependencies setup, we need to tell our build system that the script we created should be treated as an executable. We do this in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>.</p>
<p>Here, edit the <code class="docutils literal notranslate"><span class="pre">maintainer</span></code>, <code class="docutils literal notranslate"><span class="pre">maintainer_email</span></code>, <code class="docutils literal notranslate"><span class="pre">description</span></code> and <code class="docutils literal notranslate"><span class="pre">license</span></code> fields to assign exactly the same values as you did in <code class="docutils literal notranslate"><span class="pre">package.xml</span></code>.</p>
<p>Next, look for the section that starts with <code class="docutils literal notranslate"><span class="pre">entry_points={</span></code>. We edit this part to declare the executable and its entry point to look like this:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;console_scripts&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;talker = wshop_nodes.minimal_publisher:main&#39;</span><span class="p">,</span>
        <span class="p">],</span>
<span class="p">},</span>
</pre></div>
</div>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">talker</span></code> is the name we assign to the executable, <code class="docutils literal notranslate"><span class="pre">wshop_nodes</span></code> is the package, <code class="docutils literal notranslate"><span class="pre">minimal_publisher</span></code> is the name of the python file and <code class="docutils literal notranslate"><span class="pre">main</span></code> is the entry point to this executable (i.e. main function). Replace with the names you chose accordingly.</p>
<p>You can use the same prototype to declare executables in all ROS2 python packages.</p>
</div>
<div class="section" id="setup-cfg">
<h3>1.4 Setup.cfg<a class="headerlink" href="#setup-cfg" title="Permalink to this headline">¶</a></h3>
<p>The final configuration file is <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code>, which, fortunately for us, is already configured properly and needs no more changes! These settings indicate to ROS2 where the executable shall be put for discovery after building the package.</p>
</div>
</div>
<div class="section" id="subscriber-node">
<h2>2 Subscriber Node<a class="headerlink" href="#subscriber-node" title="Permalink to this headline">¶</a></h2>
<p>Similar to the publisher, we will now create a subscriber. Next to the publisher file, create another python file and paste in the code below, which will be explained next.</p>
<p>This document refers to this file as <code class="docutils literal notranslate"><span class="pre">minimal_subscriber.py</span></code>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>


<span class="k">class</span> <span class="nc">MinimalSubscriber</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;minimal_subscriber&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
            <span class="n">String</span><span class="p">,</span>
            <span class="s1">&#39;topic&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listener_callback</span><span class="p">,</span>
            <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span>  <span class="c1"># prevent unused variable warning</span>

    <span class="k">def</span> <span class="nf">listener_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;I heard: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

    <span class="n">minimal_subscriber</span> <span class="o">=</span> <span class="n">MinimalSubscriber</span><span class="p">()</span>

    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">minimal_subscriber</span><span class="p">)</span>

    <span class="c1"># Destroy the node explicitly</span>
    <span class="c1"># (optional - otherwise it will be done automatically</span>
    <span class="c1"># when the garbage collector destroys the node object)</span>
    <span class="n">minimal_subscriber</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="id1">
<h3>2.1 Explanation<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The subscriber code has many similarities to the publisher code, and in this section we review what differs.</p>
<p>The part that is immediately relevant is creating the subscriber</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;topic&#39;</span><span class="p">,</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">listener_callback</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>The first parameter to pass to the function is the msg type, the second is the name of the topic - this should be the same as declared in the publisher, the third is the callback function for the subscriber and the last is the message buffer size.</p>
<p>The nxt part to understand is the callback function.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">listener_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;I heard: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>The parameter that is automatically passed to this dunction is the incoming message. In this case, it is simply printed to console.</p>
</div>
<div class="section" id="id2">
<h3>2.2 Declaring the executable<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>We need to declare a new executable for this subscriber node. We add another line to <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> similarly as before and it would look like this:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;console_scripts&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;talker = wshop_nodes.minimal_publisher:main&#39;</span><span class="p">,</span>
                <span class="s1">&#39;listener = wshop_nodes.minimal_subscriber:main&#39;</span> 
        <span class="p">],</span>
<span class="p">},</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="build-and-run">
<h2>3 Build and run<a class="headerlink" href="#build-and-run" title="Permalink to this headline">¶</a></h2>
<p>Before building, it is always good to check if all dependencies have been installed. We execute the following from the <strong>base workspace folder</strong> (i.e. just above the src folder of your <strong>workspace</strong>):</p>
<p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">rosdep</span> <span class="pre">install</span> <span class="pre">-i</span> <span class="pre">--from-path</span> <span class="pre">src</span> <span class="pre">--rosdistro</span> <span class="pre">&lt;distro&gt;</span> <span class="pre">-y</span></code><br />Substitute <distro> with the current version of ROS2 you are running on. Ex: <code class="docutils literal notranslate"><span class="pre">foxy</span></code></p>
<p>From the same location, build the workspace:</p>
<p><code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">build</span> <span class="pre">--symlink-install</span></code></p>
<p>Now we need to source this workspace in order to be able to discover the executable that we just built:</p>
<p><code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">install/local_setup.bash</span></code></p>
<p>Finally, we are ready to run an executable. Recalling from section <strong>1.3</strong>, the name we assigned to the executable with the publisher is <code class="docutils literal notranslate"><span class="pre">talker</span></code>. So we run this:</p>
<p><code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">run</span> <span class="pre">wshop_nodes</span> <span class="pre">talker</span></code></p>
<p>Open another terminal and similarly source ros2 and this workspace to run the subscriber executable:</p>
<p><code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">run</span> <span class="pre">wshop_nodes</span> <span class="pre">listener</span></code></p>
</div>
<div class="section" id="composed-nodes">
<h2>4 Composed nodes<a class="headerlink" href="#composed-nodes" title="Permalink to this headline">¶</a></h2>
<p>We will now create a third executable, that demonstrates the node composition feature using executors. It will be a single Python script that implements two nodes - the same publisher and subscriber as above, but composes them with a single executor.</p>
<p>Create yet another python file, which for reference here is named as <code class="docutils literal notranslate"><span class="pre">composed_nodes.py</span></code> and paste the following:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rclpy</span>

<span class="kn">from</span> <span class="nn">wshop_nodes.minimal_publisher</span> <span class="kn">import</span> <span class="n">MinimalPublisher</span>
<span class="kn">from</span> <span class="nn">wshop_nodes.minimal_subscriber</span> <span class="kn">import</span> <span class="n">MinimalSubscriber</span>

<span class="kn">from</span> <span class="nn">rclpy.executors</span> <span class="kn">import</span> <span class="n">SingleThreadedExecutor</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">minimal_publisher</span> <span class="o">=</span> <span class="n">MinimalPublisher</span><span class="p">()</span>
        <span class="n">minimal_subscriber</span> <span class="o">=</span> <span class="n">MinimalSubscriber</span><span class="p">()</span>

        <span class="n">executor</span> <span class="o">=</span> <span class="n">SingleThreadedExecutor</span><span class="p">()</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">minimal_publisher</span><span class="p">)</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">minimal_subscriber</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="n">minimal_publisher</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
            <span class="n">minimal_subscriber</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="id3">
<h3>4.1 Explanation<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">wshop_nodes.minimal_publisher</span> <span class="kn">import</span> <span class="n">MinimalPublisher</span>
<span class="kn">from</span> <span class="nn">wshop_nodes.minimal_subscriber</span> <span class="kn">import</span> <span class="n">MinimalSubscriber</span>

<span class="kn">from</span> <span class="nn">rclpy.executors</span> <span class="kn">import</span> <span class="n">SingleThreadedExecutor</span>
</pre></div>
</div>
<p>We import the previous two node classes that we created into this executable.<br />We also import the single threaded executor that we will be using to compose the nodes.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">minimal_publisher</span> <span class="o">=</span> <span class="n">MinimalPublisher</span><span class="p">()</span>
<span class="n">minimal_subscriber</span> <span class="o">=</span> <span class="n">MinimalSubscriber</span><span class="p">()</span>
</pre></div>
</div>
<p>Similarly as before, we create node objects from the two node classes.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">executor</span> <span class="o">=</span> <span class="n">SingleThreadedExecutor</span><span class="p">()</span>
<span class="n">executor</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">minimal_publisher</span><span class="p">)</span>
<span class="n">executor</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">minimal_subscriber</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the new part, where we create an executor object, and add our two nodes into it.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="n">minimal_publisher</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">minimal_subscriber</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
</pre></div>
</div>
<p>Instead of spinning the main executable directly, we instead spin the executor that contains our two nodes.</p>
<p>In this case, we have added a publisher and a subscriber within the same executor to simply demonstrate how multiple nodes can be added. In a practical scenario, this may not make much sense, and requires separate executors. This, however, is a more advanced topic and out of scope for this workshop.</p>
</div>
<div class="section" id="id4">
<h3>4.2 Declaring the executable<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Similarly as the previous two cases, we need to declare a third executor that points to the code we just created, and the result would look like this:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span>    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;console_scripts&#39;</span><span class="p">:</span> <span class="p">[</span>
		<span class="s1">&#39;talker = wshop_nodes.minimal_publisher:main&#39;</span><span class="p">,</span>
		<span class="s1">&#39;listener = wshop_nodes.minimal_subscriber:main&#39;</span><span class="p">,</span>
        <span class="s1">&#39;composed = wshop_nodes.composed_nodes:main&#39;</span>
        <span class="p">],</span>
    <span class="p">},</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>4.3 Build and run<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Build the workspace and run this new executable, whose name in this case is <code class="docutils literal notranslate"><span class="pre">composed</span></code>.<br />You will observe that indeed both the publisher and subscriber are running from within the same executable.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Fraunhofer IPA.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>